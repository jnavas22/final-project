<% require "date" %>

<div align="center">
  <div>
    <h1>
      <%= @current_user.first_name%>'s Received Roommates Inquiries
    </h1>
  </div>
</div>
<div>
  <div align="center">
    <table class = "table table-hover" border="0" style="width:70%">
      <tr class="table-warning">
        <th>
        Picture
        </th>
        <th >
          First Name
        </th>
        <th >
          Last Name
        </th>
        <th >
          University
        </th>
        <th >
          Current City
        </th>
          <th >
          Expected Move-in date
        </th>
        <th>
          Received when 
        </th>
        <th>
          Status
        </th>
        <th>
          Show More
        </th>
      </tr>
      <% @my_received_requests = RoommateRequest.where({ :recipient_id => @current_user.id})%>
      <% @my_received_requests.each do |a_roommate_request| %>
        <% @this_received_request = User.where({ :id => a_roommate_request.sender_id}).at(0) %>
       <% @this_received_request_preferences = Preference.where({ :user_id => a_roommate_request.sender_id}).at(0) %>
      <tr>
       <td>
        <div style="display: flex; justify-content: center;">
        <img src="<%= @this_received_request_preferences.picture %>" class="img-responsive"  style="max-width: 100%;">
        </div>
        </td>

        <td>
          <%= @this_received_request.first_name %>
        </td>

        <td>
            <%= @this_received_request.last_name %>
        </td>
        <td>
            <%= @this_received_request.university %>
        </td>
        <td>
            <%= @this_received_request.from_city %>
        </td>
        <td>
            <%= @this_received_request.movedate.strftime("%b %d, %Y")  %>
        </td>
        <td>
          <%= time_ago_in_words(a_roommate_request.created_at) %> ago
        </td>
        <!--if you sent them a preference, and they sent you a preference, matched -->
        <% @requested_by_you = RoommateRequest.where({ :sender_id => @current_user.id}).where({ :recipient_id => @this_received_request.id}).at(0) %>
        <% @requested_to_you = RoommateRequest.where({ :recipient_id => @current_user.id}).where({ :sender_id => @this_received_request.id}).at(0) %>
        <% @contacted_by_you = ContactRequest.where({ :sender_id => @current_user.id}).where({ :recipient_id => @this_received_request.id}).at(0)%>
         <% if @requested_by_you != nil && @requested_to_you != nil && @contacted_by_you == nil %>
         <td>
         <span class="badge rounded-pill bg-success">Matched</span>
         </td>
         <% elsif @requested_by_you != nil && @requested_to_you != nil && @contacted_by_you != nil%>
         <td>
         <span class="badge rounded-pill bg-info">Contacted</span>
         </td>
         <% else %>
         <td>
          <span class="badge rounded-pill bg-warning">Pending</span>
        </td>
        <% end %>
        <td>
         <% if @requested_by_you != nil && @requested_to_you != nil %> <!-- if they've matched-->

        <a href="/personal_info/<%= a_roommate_request.id %>">Contact info</a>

        <% else %>
         <a href="/received_roommate_requests/<%= a_roommate_request.id %>">
            Show details
          </a>
        <% end %>

        </td>
        <% end %>
      </tr>
    </table>
  </div>
</div>

